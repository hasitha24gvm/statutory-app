<!DOCTYPE html>
<html>
<head>
  <title>S&E Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">

<h2 class="text-center">S&E Compliance Dashboard</h2>

<div class="row mb-3">
  <div class="col">
    <select id="state" class="form-select" onchange="loadLocations()">
      <option value="">-- All States --</option>
    </select>
  </div>
  <div class="col">
    <select id="location" class="form-select" onchange="filterTable()">
      <option value="">-- All Locations --</option>
    </select>
  </div>
  <div class="col text-end">
    <button class="btn btn-danger" onclick="logout()">Logout</button>
  </div>
</div>

<table class="table table-bordered" id="dataTable">
  <thead>
    <tr>
      <th>Entity</th>
      <th>State</th>
      <th>Location</th>
      <th>Status</th>
      <th>Certificate</th>
      <th>Address</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let tableData = [];

async function loadData() {
  const res = await fetch('/data');
  const data = await res.json();
  tableData = data;
  renderTable(data);
}

async function loadStates() {
  const res = await fetch('/states');
  const states = await res.json();
  const select = document.getElementById('state');
  states.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.state;
    opt.textContent = s.state;
    select.appendChild(opt);
  });
}

async function loadLocations() {
  const state = document.getElementById('state').value;
  document.getElementById('location').innerHTML =
    '<option value="">-- All Locations --</option>';

  if (!state) return renderTable(tableData);

  const res = await fetch(`/locations/${encodeURIComponent(state)}`);
  const locs = await res.json();

  const select = document.getElementById('location');
  locs.forEach(l => {
    const opt = document.createElement('option');
    opt.value = l.location_name;
    opt.textContent = l.location_name;
    select.appendChild(opt);
  });

  filterTable();
}

function renderTable(data) {
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';

  data.forEach(row => {
    let certs = [];
if (row.certificate_link) {
  try {
    certs = JSON.parse(row.certificate_link);
  } catch {
    certs = [row.certificate_link];
  }
}

let cert = '-';
if (certs.length > 0) {
  cert = `
  <div class="dropdown">
    <button class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
      ${certs.length} Certificates
    </button>
    <ul class="dropdown-menu">
      ${certs.map((c,i)=>`
        <li><a class="dropdown-item" href="${c}" target="_blank">
          View ${i===certs.length-1?'(Latest)':''}
        </a></li>`).join('')}
    </ul>
  </div>`;
}


    tbody.innerHTML += `
      <tr>
        <td>${row.entity || '-'}</td>
        <td>${row.state || '-'}</td>
        <td>${row.location_name || '-'}</td>
        <td>${row.status || '-'}</td>
        <td>${cert}</td>
        <td>${row.address || '-'}</td>
      </tr>
    `;
  });
}

function filterTable() {
  const state = document.getElementById('state').value;
  const loc = document.getElementById('location').value;

  let filtered = tableData;
  if (state) filtered = filtered.filter(r => r.state === state);
  if (loc) filtered = filtered.filter(r => r.location_name === loc);

  renderTable(filtered);
}

function logout() {
  fetch('/logout').then(() => window.location.href = '/');
}

window.onload = () => {
  loadStates();
  loadData();
};
</script>

</body>
</html>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
