<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="p-4">

<h3>Admin Dashboard</h3>
<button onclick="logout()" class="btn btn-danger float-end">Logout</button>

<div class="row mb-3">
  <div class="col">
    <label>State</label>
    <select id="state" class="form-select" onchange="loadLocations()">
      <option value="">-- All States --</option>
    </select>
  </div>

  <div class="col">
    <label>Location</label>
    <select id="location" class="form-select" onchange="filterTable()">
      <option value="">-- All Locations --</option>
    </select>
  </div>

  <div class="col d-flex align-items-end">
    <button class="btn btn-primary w-100" onclick="addNewRow()">+ Add Row</button>
  </div>
</div>

<table class="table table-bordered" id="dataTable">
<thead>
<tr>
<th>Entity</th>
<th>State</th>
<th>Location</th>
<th>Status</th>
<th>Certificates</th>
<th>Address</th>
<th>Remarks</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>

let tableData = [];
let editingId = null;

async function loadData() {
  const res = await fetch('/data');
  tableData = await res.json();
  renderTable(tableData);
}

async function loadStates() {
  const res = await fetch('/states');
  const states = await res.json();
  const select = document.getElementById('state');
  select.innerHTML = '<option value="">-- All States --</option>';
  states.forEach(s => {
    select.innerHTML += `<option value="${s.state}">${s.state}</option>`;
  });
}

async function loadLocations() {
  const state = document.getElementById('state').value;
  const locSelect = document.getElementById('location');
  locSelect.innerHTML = '<option value="">-- All Locations --</option>';

  if (!state) return renderTable(tableData);

  const res = await fetch(`/locations/${state}`);
  const locs = await res.json();

  locs.forEach(l => {
    locSelect.innerHTML += `<option value="${l.location_name}">${l.location_name}</option>`;
  });

  filterTable();
}

function filterTable() {
  const state = document.getElementById('state').value;
  const location = document.getElementById('location').value;

  let filtered = tableData;

  if (state) filtered = filtered.filter(r => r.state === state);
  if (location) filtered = filtered.filter(r => r.location_name === location);

  renderTable(filtered);
}

function renderTable(data) {
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';

  data.forEach(row => {

    let certs = [];
    if (row.certificate_link) {
      try {
        certs = JSON.parse(row.certificate_link);
      } catch {
        certs = [row.certificate_link];
      }
    }

    let certDropdown = 'None';
if (row.certificate_link) {
  const links = row.certificate_link.split(',').map(l => l.trim()).filter(l => l);
  if (links.length > 0) {
    certDropdown = `
      <div class="dropdown">
        <button class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
          ${links.length} Certificates
        </button>
        <ul class="dropdown-menu">
          ${links.map((link, i) => `
            <li style="display: flex; justify-content: space-between; align-items: center; padding: 4px 8px;">
              <a class="dropdown-item" href="${link}" target="_blank" style="flex: 1;">
                View Certificate ${i + 1} ${i === links.length - 1 ? '(Latest)' : ''}
              </a>
              <a class="dropdown-item" href="${link}" download style="flex: 0 0 auto; margin-right: 8px;">Download</a>
              <button class="btn btn-sm btn-danger" style="font-size: 0.8rem;" onclick="deleteCertLink(${row.id}, '${link.replace(/'/g, "\\'")}')">
                Delete
              </button>
            </li>
          `).join('')}
        </ul>
      </div>`;
  }
}

    tbody.innerHTML += `
    <tr data-id="${row.id}">
    <td>
  ${certDropdown}
  <div class="input-group input-group-sm mt-1">
    <input type="text" id="certLink_${row.id}" placeholder="Paste Google Drive link" class="form-control">
    <button class="btn btn-success btn-sm" onclick="addCertLink(${row.id})">Add Link</button>
  </div>
</td>
    </tr>`;
  });
}

/* ================= ADD ROW ================= */

function addNewRow() {
  if (document.querySelector('.newRow')) return;

  const tbody = document.querySelector('#dataTable tbody');

  tbody.insertAdjacentHTML("afterbegin", `
  <tr class="newRow">
    <td><input name="entity" class="form-control"></td>
    <td><input name="state" class="form-control"></td>
    <td><input name="location_name" class="form-control"></td>
    <td><input name="status" class="form-control"></td>
    <td><input type="file" name="certificate" class="form-control"></td>
    <td><input name="address" class="form-control"></td>
    <td><input name="remarks" class="form-control"></td>
    <td>
      <button class="btn btn-success btn-sm" onclick="saveNewRow()">Save</button>
      <button class="btn btn-secondary btn-sm" onclick="cancelNewRow()">Cancel</button>
    </td>
  </tr>`);
}

function cancelNewRow() {
  const row = document.querySelector('.newRow');
  if (row) row.remove();
}

async function saveNewRow() {
  const row = document.querySelector('.newRow');
  const formData = new FormData();

  row.querySelectorAll('input').forEach(i=>{
    if(i.type==='file' && i.files[0]) formData.append('certificate',i.files[0]);
    else formData.append(i.name,i.value);
  });

  await fetch('/add-row',{method:'POST',body:formData});
  loadData();
}

/* ================= EDIT ================= */

function editRow(id) {

  if (editingId) return;
  editingId = id;

  const tr = document.querySelector(`tr[data-id="${id}"]`);
  const cells = tr.querySelectorAll("td");

  cells[0].innerHTML = `<input class="form-control" value="${cells[0].innerText}">`;
  cells[1].innerHTML = `<input class="form-control" value="${cells[1].innerText}">`;
  cells[2].innerHTML = `<input class="form-control" value="${cells[2].innerText}">`;
  cells[3].innerHTML = `<input class="form-control" value="${cells[3].innerText}">`;
  cells[4].innerHTML = `<input type="file" class="form-control">`;
  cells[5].innerHTML = `<input class="form-control" value="${cells[5].innerText}">`;
  cells[6].innerHTML = `<input class="form-control" value="${cells[6].innerText}">`;

  cells[7].innerHTML = `
    <button class="btn btn-success btn-sm" onclick="saveEdit(${id})">Save</button>
    <button class="btn btn-secondary btn-sm" onclick="cancelEdit()">Cancel</button>
  `;
}

async function saveEdit(id) {

  const tr = document.querySelector(`tr[data-id="${id}"]`);
  const inputs = tr.querySelectorAll("input");

  const formData = new FormData();

  formData.append("entity", inputs[0].value);
  formData.append("state", inputs[1].value);
  formData.append("location_name", inputs[2].value);
  formData.append("status", inputs[3].value);

  if (inputs[4].files[0]) {
    formData.append("certificate", inputs[4].files[0]);
  }

  formData.append("address", inputs[5].value);
  formData.append("remarks", inputs[6].value);

  await fetch(`/edit-row/${id}`, {
    method: "POST",
    body: formData
  });

  editingId = null;
  loadData();
}

function cancelEdit() {
  editingId = null;
  loadData();
}

async function deleteRow(id){
  if(!confirm("Delete?")) return;
  await fetch(`/delete-row/${id}`,{method:'POST'});
  loadData();
}

function uploadCert(id) {
  const input = document.createElement('input');
  input.type = 'file';
  input.onchange = async e => {
    const formData = new FormData();
    formData.append('certificate', e.target.files[0]);
    await fetch(`/edit-row/${id}`, { method:'POST', body:formData });
    loadData();
  };
  input.click();
}

function logout(){
  fetch('/logout').then(()=>window.location='/');
}

window.onload = ()=>{
  loadStates();
  loadData();
};

async function addCertLink(id) {
  const input = document.getElementById(`certLink_${id}`);
  const newLink = input.value.trim();
  if (!newLink) return alert('Please paste a valid Google Drive link');

  const row = tableData.find(r => r.id == id);
  let currentLinks = [];
  if (row.certificate_link) {
    currentLinks = row.certificate_link.split(',').map(l => l.trim()).filter(l => l);
  } 
  if (currentLinks.includes(newLink)) return alert('This link is already added');

  currentLinks.push(newLink);

  const res = await fetch(`/update-cert-links/${id}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ certificate_link: currentLinks.join(',') })
  });
  const data = await res.json();

  if (data.success) {
    alert('Link added successfully!');
    input.value = '';
    loadData();
  } else {
    alert(data.error || 'Failed to save link');
  }
}

async function deleteCertLink(id, linkToDelete) {
  if (!confirm('Delete this certificate link?')) return;

  const row = tableData.find(r => r.id == id);
  let currentLinks = [];
  if (row.certificate_link) {
    currentLinks = row.certificate_link.split(',').map(l => l.trim()).filter(l => l);
  }

  currentLinks = currentLinks.filter(link => link !== linkToDelete);

  const res = await fetch(`/update-cert-links/${id}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ certificate_link: currentLinks.join(',') })
  });
  const data = await res.json();

  if (data.success) {
    alert('Link deleted!');
    loadData();
  } else {
    alert(data.error || 'Failed to delete');
  }
}

</script>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
