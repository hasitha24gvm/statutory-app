<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="p-4">

<h3>Admin Dashboard</h3>
<button onclick="logout()" class="btn btn-danger float-end">Logout</button>

<div class="row mb-3">
  <div class="col">
    <label>State</label>
    <select id="state" class="form-select" onchange="loadLocations()">
      <option value="">-- All States --</option>
    </select>
  </div>

  <div class="col">
    <label>Location</label>
    <select id="location" class="form-select" onchange="filterTable()">
      <option value="">-- All Locations --</option>
    </select>
  </div>

  <div class="col d-flex align-items-end">
    <button class="btn btn-primary w-100" onclick="addNewRow()">+ Add Row</button>
  </div>
</div>

<table class="table table-bordered" id="dataTable">
<thead>
<tr>
<th>Entity</th>
<th>State</th>
<th>Location</th>
<th>Status</th>
<th>Certificates</th>
<th>Address</th>
<th>Remarks</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>

let tableData = [];
let editingId = null;

async function loadData() {
  const res = await fetch('/data');
  tableData = await res.json();
  renderTable(tableData);
}

async function loadStates() {
  const res = await fetch('/states');
  const states = await res.json();
  const select = document.getElementById('state');
  select.innerHTML = '<option value="">-- All States --</option>';

  states.forEach(s => {
    select.innerHTML += `<option value="${s.state}">${s.state}</option>`;
  });
}

async function loadLocations() {
  const state = document.getElementById('state').value;
  const locSelect = document.getElementById('location');
  locSelect.innerHTML = '<option value="">-- All Locations --</option>';

  if (!state) return renderTable(tableData);

  const res = await fetch(`/locations/${state}`);
  const locs = await res.json();

  locs.forEach(l => {
    locSelect.innerHTML += `<option value="${l.location_name}">${l.location_name}</option>`;
  });

  filterTable();
}

function filterTable() {
  const state = document.getElementById('state').value;
  const location = document.getElementById('location').value;

  let filtered = tableData;

  if (state) filtered = filtered.filter(r => r.state === state);
  if (location) filtered = filtered.filter(r => r.location_name === location);

  renderTable(filtered);
}

function renderTable(data) {
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';

  data.forEach(row => {

    let certs = [];
    if (row.certificate_link) {
      try {
        certs = JSON.parse(row.certificate_link);
      } catch {
        certs = [row.certificate_link];
      }
    }

    let certDropdown = 'None';
    if (certs.length > 0) {
      certDropdown = `
      <div class="dropdown">
        <button class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
          ${certs.length} Certificates
        </button>
        <ul class="dropdown-menu">
          ${certs.map((c,i)=>`
            <li><a class="dropdown-item" href="${c}" target="_blank">
              View ${i===certs.length-1?'(Latest)':''}
            </a></li>`).join('')}
        </ul>
      </div>`;
    }

    tbody.innerHTML += `
    <tr data-id="${row.id}">
      <td>${row.entity}</td>
      <td>${row.state}</td>
      <td>${row.location_name}</td>
      <td>${row.status}</td>
      <td>
        ${certDropdown}
        <button class="btn btn-sm btn-info mt-1" onclick="uploadCert(${row.id})">Upload</button>
      </td>
      <td>${row.address}</td>
      <td>${row.remarks}</td>
      <td>
        <button class="btn btn-warning btn-sm" onclick="editRow(${row.id})">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteRow(${row.id})">Delete</button>
      </td>
    </tr>`;
  });
}

function uploadCert(id) {
  const input = document.createElement('input');
  input.type = 'file';
  input.onchange = async e => {
    const formData = new FormData();
    formData.append('certificate', e.target.files[0]);
    await fetch(`/edit-row/${id}`, { method:'POST', body:formData });
    loadData();
  };
  input.click();
}

function addNewRow() {
  if (document.querySelector('.newRow')) return;

  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = `
  <tr class="newRow">
    <td><input name="entity" class="form-control"></td>
    <td><input name="state" class="form-control"></td>
    <td><input name="location_name" class="form-control"></td>
    <td><input name="status" class="form-control"></td>
    <td><input type="file" name="certificate" class="form-control"></td>
    <td><input name="address" class="form-control"></td>
    <td><input name="remarks" class="form-control"></td>
    <td>
      <button class="btn btn-success btn-sm" onclick="saveNewRow()">Save</button>
    </td>
  </tr>` + tbody.innerHTML;
}

async function saveNewRow() {
  const row = document.querySelector('.newRow');
  const formData = new FormData();
  row.querySelectorAll('input').forEach(i=>{
    if(i.type==='file' && i.files[0]) formData.append('certificate',i.files[0]);
    else formData.append(i.name,i.value);
  });

  await fetch('/add-row',{method:'POST',body:formData});
  loadData();
}

function editRow(id){
  alert("Edit logic can be expanded if needed.");
}

async function deleteRow(id){
  if(!confirm("Delete?")) return;
  await fetch(`/delete-row/${id}`,{method:'POST'});
  loadData();
}

function logout(){
  fetch('/logout').then(()=>window.location='/');
}

window.onload = ()=>{
  loadStates();
  loadData();
};

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
