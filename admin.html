<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://pgexcbjryrtkzbrertma.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_ukjwUCjlgu-OdW91Jd0iFQ_-GXY3Dup';
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);
  </script>
</head>

<body class="p-4">

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Admin Dashboard</h3>
  <button onclick="logout()" class="btn btn-danger">Logout</button>
</div>

<!-- ── FILTERS + ADD BUTTON ──────────────────────────────── -->
<div class="row mb-3">
  <div class="col">
    <label>State</label>
    <select id="state" class="form-select" onchange="onStateChange()">
      <option value="">-- All States --</option>
    </select>
  </div>
  <div class="col">
    <label>Location</label>
    <select id="location" class="form-select" onchange="filterTable()">
      <option value="">-- All Locations --</option>
    </select>
  </div>
  <div class="col d-flex align-items-end">
    <button class="btn btn-primary w-100" onclick="addNewRow()">+ Add Row</button>
  </div>
</div>

<!-- ── STATUS MESSAGE ────────────────────────────────────── -->
<div id="statusMsg" class="alert d-none mb-3"></div>

<!-- ── DATA TABLE ────────────────────────────────────────── -->
<div class="table-responsive">
  <table class="table table-bordered" id="dataTable">
    <thead class="table-dark">
      <tr>
        <th>Entity</th>
        <th>State</th>
        <th>Location</th>
        <th>Status</th>
        <th>Certificates</th>
        <th>Address</th>
        <th>Remarks</th>
        <th style="min-width:140px">Actions</th>
      </tr>
    </thead>
    <tbody id="admin-table-body">
      <tr><td colspan="8" class="text-center text-muted">Loading...</td></tr>
    </tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>

  let tableData = [];  // all rows from Supabase
  let editingId = null;

  // ── HELPERS ────────────────────────────────────────────────
  function showStatus(msg, type = 'success') {
    const el = document.getElementById('statusMsg');
    el.textContent = msg;
    el.className = `alert alert-${type} mb-3`;
    setTimeout(() => el.className = 'alert d-none mb-3', 3500);
  }

  // ── 1. LOAD ALL DATA FROM SUPABASE ────────────────────────
  async function loadData() {
    const { data, error } = await db
      .from('se_compliance')
      .select('*')
      .order('state', { ascending: true });

    if (error) {
      showStatus('Failed to load data: ' + error.message, 'danger');
      return;
    }

    tableData = data;
    populateStateDropdown(data);
    renderTable(data);
  }

  // ── 2. FILL STATE DROPDOWN ─────────────────────────────────
  function populateStateDropdown(data) {
    const states = [...new Set(data.map(r => r.state).filter(Boolean))].sort();
    const select = document.getElementById('state');
    const current = select.value;
    select.innerHTML = '<option value="">-- All States --</option>';
    states.forEach(s => {
      select.innerHTML += `<option value="${s}" ${s === current ? 'selected' : ''}>${s}</option>`;
    });
  }

  // ── 3. STATE CHANGES → FILL LOCATIONS ─────────────────────
  function onStateChange() {
    const selectedState = document.getElementById('state').value;
    const locSelect = document.getElementById('location');
    locSelect.innerHTML = '<option value="">-- All Locations --</option>';

    if (selectedState) {
      const locs = [...new Set(
        tableData.filter(r => r.state === selectedState).map(r => r.location_name).filter(Boolean)
      )].sort();
      locs.forEach(l => {
        locSelect.innerHTML += `<option value="${l}">${l}</option>`;
      });
    }
    filterTable();
  }

  // ── 4. FILTER TABLE ────────────────────────────────────────
  function filterTable() {
    const state = document.getElementById('state').value;
    const loc   = document.getElementById('location').value;
    let filtered = tableData;
    if (state) filtered = filtered.filter(r => r.state === state);
    if (loc)   filtered = filtered.filter(r => r.location_name === loc);
    renderTable(filtered);
  }

  // ── 5. RENDER TABLE ────────────────────────────────────────
  function renderTable(data) {
    const tbody = document.getElementById('admin-table-body');

    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No records found.</td></tr>';
      return;
    }

    tbody.innerHTML = data.map(row => {
      // Parse certificate links (single URL or JSON array)
      let certs = [];
      if (row.certificate_link) {
        try { certs = JSON.parse(row.certificate_link); }
        catch { certs = [row.certificate_link]; }
      }

      const certDropdown = certs.length > 0
        ? `<div class="dropdown mb-1">
            <button class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
              ${certs.length} Certificate${certs.length > 1 ? 's' : ''}
            </button>
            <ul class="dropdown-menu">
              ${certs.map((c, i) => `
                <li><a class="dropdown-item" href="${c}" target="_blank">View ${i === certs.length - 1 ? '(Latest)' : ''}</a></li>
                <li><a class="dropdown-item" href="${c}" download>Download</a></li>
              `).join('')}
            </ul>
           </div>`
        : '<span class="text-muted">None</span>';

      return `
        <tr data-id="${row.id}">
          <td>${row.entity        || '-'}</td>
          <td>${row.state         || '-'}</td>
          <td>${row.location_name || '-'}</td>
          <td>${row.status        || '-'}</td>
          <td>
            ${certDropdown}
            <button class="btn btn-info btn-sm mt-1" onclick="uploadCert(${row.id})">+ Upload</button>
          </td>
          <td>${row.address  || '-'}</td>
          <td>${row.remarks  || '-'}</td>
          <td>
            <button class="btn btn-warning btn-sm" onclick="editRow(${row.id})">Edit</button>
            <button class="btn btn-danger  btn-sm" onclick="deleteRow(${row.id})">Delete</button>
          </td>
        </tr>`;
    }).join('');
  }

  // ── 6. ADD NEW ROW ─────────────────────────────────────────
  function addNewRow() {
    if (document.querySelector('.newRow')) return; // prevent double-click

    const tbody = document.getElementById('admin-table-body');
    const newRowHTML = `
      <tr class="newRow table-light">
        <td><input name="entity"        class="form-control form-control-sm"></td>
        <td><input name="state"         class="form-control form-control-sm"></td>
        <td><input name="location_name" class="form-control form-control-sm"></td>
        <td><input name="status"        class="form-control form-control-sm"></td>
        <td><input type="file" name="certificate" class="form-control form-control-sm"></td>
        <td><input name="address"       class="form-control form-control-sm"></td>
        <td><input name="remarks"       class="form-control form-control-sm"></td>
        <td>
          <button class="btn btn-success btn-sm" onclick="saveNewRow()">Save</button>
          <button class="btn btn-secondary btn-sm" onclick="cancelNewRow()">Cancel</button>
        </td>
      </tr>`;

    tbody.insertAdjacentHTML('afterbegin', newRowHTML);
  }

  function cancelNewRow() {
    const row = document.querySelector('.newRow');
    if (row) row.remove();
  }

  async function saveNewRow() {
    const row = document.querySelector('.newRow');
    const get = name => row.querySelector(`[name="${name}"]`).value.trim();
    const fileInput = row.querySelector('input[type="file"]');

    const newRecord = {
      entity:        get('entity'),
      state:         get('state'),
      location_name: get('location_name'),
      status:        get('status'),
      address:       get('address'),
      remarks:       get('remarks'),
      certificate_link: null
    };

    if (!newRecord.entity || !newRecord.state || !newRecord.location_name) {
      showStatus('Entity, State and Location are required.', 'warning');
      return;
    }

    // Upload certificate file first if provided
    if (fileInput.files[0]) {
      const url = await uploadFileToStorage(fileInput.files[0]);
      if (url) newRecord.certificate_link = JSON.stringify([url]);
    }

    const { error } = await db.from('se_compliance').insert(newRecord);

    if (error) {
      showStatus('Failed to add record: ' + error.message, 'danger');
    } else {
      showStatus('Record added successfully!', 'success');
      cancelNewRow();
      loadData();
    }
  }

  // ── 7. EDIT ROW ────────────────────────────────────────────
  function editRow(id) {
    if (editingId) {
      showStatus('Please save or cancel the current edit first.', 'warning');
      return;
    }
    editingId = id;

    const tr = document.querySelector(`tr[data-id="${id}"]`);
    const row = tableData.find(r => r.id === id);

    tr.innerHTML = `
      <td><input class="form-control form-control-sm" id="e-entity"   value="${row.entity        || ''}"></td>
      <td><input class="form-control form-control-sm" id="e-state"    value="${row.state         || ''}"></td>
      <td><input class="form-control form-control-sm" id="e-location" value="${row.location_name || ''}"></td>
      <td><input class="form-control form-control-sm" id="e-status"   value="${row.status        || ''}"></td>
      <td>
        <small class="text-muted d-block mb-1">Upload new cert (optional):</small>
        <input type="file" id="e-cert" class="form-control form-control-sm">
      </td>
      <td><input class="form-control form-control-sm" id="e-address"  value="${row.address  || ''}"></td>
      <td><input class="form-control form-control-sm" id="e-remarks"  value="${row.remarks  || ''}"></td>
      <td>
        <button class="btn btn-success btn-sm" onclick="saveEdit(${id})">Save</button>
        <button class="btn btn-secondary btn-sm" onclick="cancelEdit()">Cancel</button>
      </td>`;
  }

  async function saveEdit(id) {
    const row      = tableData.find(r => r.id === id);
    const fileInput = document.getElementById('e-cert');

    const updated = {
      entity:        document.getElementById('e-entity').value.trim(),
      state:         document.getElementById('e-state').value.trim(),
      location_name: document.getElementById('e-location').value.trim(),
      status:        document.getElementById('e-status').value.trim(),
      address:       document.getElementById('e-address').value.trim(),
      remarks:       document.getElementById('e-remarks').value.trim(),
      updated_at:    new Date().toISOString()
    };

    // If a new file is uploaded, append its URL to existing cert list
    if (fileInput && fileInput.files[0]) {
      const newUrl = await uploadFileToStorage(fileInput.files[0]);
      if (newUrl) {
        let existing = [];
        if (row.certificate_link) {
          try { existing = JSON.parse(row.certificate_link); }
          catch { existing = [row.certificate_link]; }
        }
        existing.push(newUrl);
        updated.certificate_link = JSON.stringify(existing);
      }
    }

    const { error } = await db
      .from('se_compliance')
      .update(updated)
      .eq('id', id);

    if (error) {
      showStatus('Update failed: ' + error.message, 'danger');
    } else {
      showStatus('Record updated successfully!', 'success');
      editingId = null;
      loadData();
    }
  }

  function cancelEdit() {
    editingId = null;
    loadData(); // re-render to restore the row
  }

  // ── 8. DELETE ROW ──────────────────────────────────────────
  async function deleteRow(id) {
    if (!confirm('Are you sure you want to delete this record? This cannot be undone.')) return;

    const { error } = await db
      .from('se_compliance')
      .delete()
      .eq('id', id);

    if (error) {
      showStatus('Delete failed: ' + error.message, 'danger');
    } else {
      showStatus('Record deleted.', 'success');
      loadData();
    }
  }

  // ── 9. UPLOAD CERTIFICATE (adds to existing certs list) ────
  function uploadCert(id) {
    const input = document.createElement('input');
    input.type  = 'file';
    input.accept = '.pdf,.jpg,.jpeg,.png';

    input.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      showStatus('Uploading certificate...', 'info');
      const newUrl = await uploadFileToStorage(file);

      if (!newUrl) {
        showStatus('File upload failed. Check Supabase Storage bucket setup.', 'danger');
        return;
      }

      // Append new URL to existing certificate list
      const row = tableData.find(r => r.id === id);
      let existing = [];
      if (row.certificate_link) {
        try { existing = JSON.parse(row.certificate_link); }
        catch { existing = [row.certificate_link]; }
      }
      existing.push(newUrl);

      const { error } = await db
        .from('se_compliance')
        .update({ certificate_link: JSON.stringify(existing) })
        .eq('id', id);

      if (error) {
        showStatus('Saved upload URL failed: ' + error.message, 'danger');
      } else {
        showStatus('Certificate uploaded and saved!', 'success');
        loadData();
      }
    };

    input.click();
  }

  // ── 10. UPLOAD FILE TO SUPABASE STORAGE ───────────────────
  // IMPORTANT: You must create a Storage bucket called "certificates"
  // in Supabase → Storage → New Bucket → name: certificates → Public: ON
  async function uploadFileToStorage(file) {
    const fileName = `${Date.now()}_${file.name.replace(/\s+/g, '_')}`;

    const { data, error } = await db.storage
      .from('certificates')        // ← bucket name
      .upload(fileName, file, { upsert: true });

    if (error) {
      console.error('Storage upload error:', error.message);
      return null;
    }

    // Get the public URL for the uploaded file
    const { data: urlData } = db.storage
      .from('certificates')
      .getPublicUrl(fileName);

    return urlData.publicUrl;
  }

  // ── 11. LOGOUT ─────────────────────────────────────────────
  function logout() {
    sessionStorage.clear();
    window.location.href = 'index.html';
  }

  // ── 12. INIT — CHECK ADMIN ACCESS THEN LOAD ────────────────
  window.onload = function () {
    const role = sessionStorage.getItem('user_role');
    if (role !== 'admin') {
      // Not an admin — send back to login
      window.location.href = 'index.html';
      return;
    }
    loadData();
  };

</script>
</body>
</html>
